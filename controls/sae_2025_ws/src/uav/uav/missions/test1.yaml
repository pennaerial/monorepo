# Mission YAML implementing the FSM structure
# Note: This is a flattened version of the FSM since ModeManager supports flat structures
# Some states may require custom Mode classes to be implemented

# start - Initialization state (entry point)
start:
  class: uav.autonomous_modes.Mode  # TODO: Implement InitMode class
  params:
    # Add initialization parameters here
  transitions:
    OK: ARM
    FAIL: FAULT

# INIT - Alias to start for FSM clarity
INIT:
  class: uav.autonomous_modes.Mode  # TODO: Implement InitMode class
  params:
    # Add initialization parameters here
  transitions:
    OK: ARM
    FAIL: FAULT

# ARM - Arm the vehicle
ARM:
  class: uav.autonomous_modes.Mode  # TODO: Implement ArmMode class
  params:
    # Add arm parameters here
  transitions:
    ARMED: TAKEOFF
    FAIL: FAULT

# TAKEOFF - Takeoff to initial altitude
TAKEOFF:
  class: uav.autonomous_modes.NavGPSMode
  params:
    coordinates: '[((0, 0, -5), 3, "LOCAL")]'  # Takeoff to 5m altitude
    margin: '1.0'
  transitions:
    complete: NAV_TO_START
    # Note: BAD_HEALTH transition would need to be handled in mode logic
    BAD_HEALTH: ABORT_RTL

# NAV_TO_START - Navigate to course start position
NAV_TO_START:
  class: uav.autonomous_modes.NavGPSMode
  params:
    coordinates: '[((0, 0, -2), 2, "LOCAL")]'  # TODO: Set actual start coordinates
    margin: '1.0'
  transitions:
    complete: RUN_COURSE_ACQUIRE_NEXT_HOOP
    # Note: STUCK transition would need timeout logic in mode
    STUCK: ABORT_RTL

# RUN_COURSE states (flattened from nested structure)

# ACQUIRE_NEXT_HOOP - Find next hoop to fly through
RUN_COURSE_ACQUIRE_NEXT_HOOP:
  class: uav.autonomous_modes.Mode  # TODO: Implement AcquireNextHoopMode class
  params:
    # Parameters for finding next hoop
  transitions:
    FOUND: RUN_COURSE_ALIGN_TO_HOOP
    NONE_LEFT: RUN_COURSE_EXIT_COURSE
    TIMEOUT: RUN_COURSE_SEARCH_PATTERN
    EMERGENCY: ABORT_RTL

# SEARCH_PATTERN - Execute search pattern if hoop not found
RUN_COURSE_SEARCH_PATTERN:
  class: uav.autonomous_modes.Mode  # TODO: Implement SearchPatternMode class
  params:
    # Parameters for search pattern
  transitions:
    FOUND: RUN_COURSE_ALIGN_TO_HOOP
    TIMEOUT: ABORT_RTL

# ALIGN_TO_HOOP - Align drone to hoop for passage
RUN_COURSE_ALIGN_TO_HOOP:
  class: uav.autonomous_modes.Mode  # TODO: Implement AlignToHoopMode class
  params:
    # Parameters for alignment
  transitions:
    ALIGNED: RUN_COURSE_TRANSIT_THROUGH

# TRANSIT_THROUGH - Fly through the hoop
RUN_COURSE_TRANSIT_THROUGH:
  class: uav.autonomous_modes.NavGPSMode  # TODO: Could use NavGPSMode or custom mode
  params:
    # Coordinates for passing through hoop (would be set dynamically)
    coordinates: '[]'
    margin: '1.5'
  transitions:
    complete: RUN_COURSE_ACQUIRE_NEXT_HOOP
    # Note: PASSED transition should map to complete

# EXIT_COURSE - Complete course and prepare to return
RUN_COURSE_EXIT_COURSE:
  class: uav.autonomous_modes.Mode  # TODO: Implement ExitCourseMode class
  params:
    # Parameters for exiting course
  transitions:
    DONE: RETURN_HOME

# RETURN_HOME - Return to home position
RETURN_HOME:
  class: uav.autonomous_modes.NavGPSMode
  params:
    coordinates: '[((0, 0, -2), 5, "LOCAL")]'  # Return to origin at 2m altitude
    margin: '1.0'
  transitions:
    complete: LAND
    # Note: HOME transition maps to complete
    EMERGENCY: EMERGENCY_RTL

# LAND - Land the vehicle
LAND:
  class: uav.autonomous_modes.LandingMode
  params:
    # Landing parameters
  transitions:
    # Note: DISARMED transition would need to be handled in LandingMode
    complete: DONE
    FAIL: EMERGENCY_LAND

# ABORT_RTL - Abort and return to launch
ABORT_RTL:
  class: uav.autonomous_modes.NavGPSMode
  params:
    coordinates: '[((0, 0, -2), 5, "LOCAL")]'  # Return to launch position
    margin: '1.0'
  transitions:
    complete: LAND
    # Note: HOME transition maps to complete

# EMERGENCY_RTL - Emergency return to launch
EMERGENCY_RTL:
  class: uav.autonomous_modes.NavGPSMode
  params:
    coordinates: '[((0, 0, -2), 5, "LOCAL")]'  # Emergency return to launch
    margin: '1.0'
  transitions:
    complete: LAND
    # Note: HOME transition maps to complete

# EMERGENCY_LAND - Emergency landing
EMERGENCY_LAND:
  class: uav.autonomous_modes.LandingMode
  params:
    # Emergency landing parameters
  transitions:
    # Note: DISARMED transition would need to be handled
    complete: DONE

# FAULT - Fault state
FAULT:
  class: uav.autonomous_modes.Mode  # TODO: Implement FaultMode class
  params:
    # Fault handling parameters
  transitions:
    RESET: start

# DONE - Mission complete (terminal state)
DONE:
  class: uav.autonomous_modes.Mode  # TODO: Implement DoneMode class or use LandingMode
  params:
    # Final state - no transitions
  transitions: {}

