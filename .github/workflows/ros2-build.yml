name: ROS 2 Build for Raspberry Pi

on:
  push:
    branches: [main, master, integration]
    paths:
      - '.github/workflows/ros2-build.yml'
      - 'controls/sae_2025_ws/**'
  pull_request:
    branches: [main, master]
    paths:
      - 'controls/sae_2025_ws/**'
  workflow_dispatch:  # Manual trigger

env:
  ROS_DISTRO: humble

jobs:
  build:
    name: Build ROS 2 Workspace (ARM64 via QEMU)
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Set up QEMU for ARM64 emulation
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Get short SHA
        id: sha
        run: echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      
      - name: Get build info
        id: info
        run: |
          echo "timestamp=$(date -u +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
      
      - name: Build ARM64 Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./controls/sae_2025_ws
          file: ./controls/sae_2025_ws/Dockerfile.build
          platforms: linux/arm64
          push: false
          load: true
          tags: ros2-build:arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Extract build artifacts from container
        working-directory: controls/sae_2025_ws
        run: |
          # Create output directory
          mkdir -p deploy-out
          
          # Run container to copy out the deploy directory
          docker run --rm --platform linux/arm64 \
            -v $PWD/deploy-out:/deploy-out \
            ros2-build:arm64
          
          # Move to expected location
          mv deploy-out/deploy deploy || mv deploy-out deploy
          
          ls -la deploy/
      
      - name: Create build metadata
        working-directory: controls/sae_2025_ws
        run: |
          cat > deploy/install/BUILD_INFO.txt << EOF
          Build Information
          =================
          Commit SHA: ${{ github.sha }}
          Short SHA: ${{ steps.sha.outputs.short_sha }}
          Build Time: ${{ steps.info.outputs.timestamp }}
          Branch: ${{ github.ref_name }}
          ROS Distro: humble
          Target Architecture: arm64 (Raspberry Pi compatible)
          Build Method: Docker + QEMU cross-compilation
          
          Deployment Instructions:
          1. Extract to your Raspberry Pi
          2. cd to the extracted directory
          3. Source: source /opt/ros/humble/setup.bash && source install/setup.bash
          4. Run: ros2 launch uav main.launch.py
          
          Environment Overrides:
          - UAV_SIM=false (already set in hardware config)
          - UAV_MISSION=mission_name
          - UAV_DEBUG=true/false
          EOF
      
      - name: Package build artifacts
        working-directory: controls/sae_2025_ws
        run: |
          cd deploy
          tar -czvf ../ros2-build-${{ steps.sha.outputs.short_sha }}.tar.gz .
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ros2-build-${{ steps.sha.outputs.short_sha }}
          path: controls/sae_2025_ws/ros2-build-${{ steps.sha.outputs.short_sha }}.tar.gz
          retention-days: 30
      
      - name: Create GitHub Release (on main/master push)
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ steps.sha.outputs.short_sha }}
          name: ROS 2 Build ${{ steps.sha.outputs.short_sha }}
          body: |
            ## ROS 2 Build for Raspberry Pi (ARM64)
            
            **Commit:** ${{ github.sha }}
            **Built:** ${{ steps.info.outputs.timestamp }}
            **Branch:** ${{ github.ref_name }}
            **Method:** Docker + QEMU cross-compilation
            
            ### Quick Deploy to Raspberry Pi
            
            ```bash
            # Download and extract
            mkdir -p ~/uav_ws && cd ~/uav_ws
            wget https://github.com/${{ github.repository }}/releases/download/build-${{ steps.sha.outputs.short_sha }}/ros2-build-${{ steps.sha.outputs.short_sha }}.tar.gz
            tar -xzvf ros2-build-${{ steps.sha.outputs.short_sha }}.tar.gz
            rm ros2-build-${{ steps.sha.outputs.short_sha }}.tar.gz
            
            # Source ROS 2 and the workspace
            source /opt/ros/humble/setup.bash
            source install/setup.bash
            
            # Run (sim=false is already set in launch_params.yaml)
            ros2 launch uav main.launch.py
            ```
            
            ### Configuration
            
            Edit `launch_params.yaml` to customize mission, vehicle type, etc.
            Or use environment variables:
            ```bash
            UAV_MISSION=my_mission ros2 launch uav main.launch.py
            ```
          files: controls/sae_2025_ws/ros2-build-${{ steps.sha.outputs.short_sha }}.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
